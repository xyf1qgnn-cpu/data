{
  "id": "snapshot_1767712404648_5af2l2ir3",
  "approvalId": "approval_1767712404622_er9izywcn",
  "approvalTitle": "AI视觉处理改进需求 - JSON约束和智能页面筛选",
  "version": 1,
  "timestamp": "2026-01-06T15:13:24.647Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document\n\n## Introduction\n\n当前CFST数据提取系统已从文本分析（pdfplumber）升级到视觉分析（pdf2image + AI）。在实际测试中发现了两个关键问题需要解决：\n1. AI模型返回的JSON响应因Token溢出而被截断，导致解析失败\n2. 简单的页面截断策略（只读前N页）效率低下，可能漏掉关键数据或浪费API调用\n\n本需求旨在通过Prompt约束和智能页面筛选机制，提升系统的可靠性和成本效率。\n\n## Alignment with Product Vision\n\n这些改进支持产品愿景中的以下目标：\n- **提高数据提取成功率**：通过解决JSON截断问题，减少处理失败率\n- **降低运营成本**：智能页面筛选减少不必要的API调用\n- **提升数据完整性**：确保关键数据表不会被遗漏\n\n## Requirements\n\n### Requirement 1: JSON输出格式约束\n\n**User Story**: 作为系统管理员，我希望确保AI模型只返回纯JSON格式且reason字段受限，这样可以避免Token溢出导致的JSON截断和解析失败。\n\n#### Acceptance Criteria\n\n1. WHEN AI模型处理PDF并生成响应时 THEN 系统SHALL在System Prompt中明确要求：\n   - 只输出纯JSON字符串，不包含Markdown代码块标记（```json）\n   - reason字段必须为empty string `\"\"` 或最多10个单词的简短说明\n   - 不包含任何解释性文字或前言\n\n2. IF AI返回的JSON包含被截断的字符串 THEN 系统SHALL记录该错误并优雅处理\n\n3. WHEN AI返回有效JSON时 THEN 系统SHALL验证JSON结构完整性并正常解析\n\n### Requirement 2: 智能页面筛选机制\n\n**User Story**: 作为系统用户，我希望系统能智能识别包含试验数据的页面，而不是简单地截断前N页，这样可以确保提取到所有相关数据同时减少不必要的API成本。\n\n#### Acceptance Criteria\n\n1. WHEN 处理一个PDF文件时 THEN 系统SHALL执行两阶段分析：\n   - 阶段一：文本侦察（本地CPU处理，不调用API）\n     * 使用pdfplumber快速提取每页文本\n     * 基于关键词命中率为每页打分\n     * 按分数排序并选择Top N页（例如8页），强制包含第1页\n\n   - 阶段二：视觉提取（调用AI API）\n     * 只将阶段一选出的页面转换为图片\n     * 使用现有视觉处理流程提取数据\n\n2. 评分系统SHALL按以下规则计算每页得分：\n   - 高权重 (+10)：检测到表格标题（\"Table 1\", \"Tab. 2\", 等）\n   - 中权重 (+5)：检测到关键数据词汇（\"Specimen\", \"Experimental\", \"kN\", \"mm\", \"B/t\", \"D/t\"等）\n   - 普通文本：+1\n   - 参考文献/引用页：-5\n\n3. IF PDF页数 ≤ 15页 THEN 系统SHALL跳过筛选机制，处理所有页面（保持现有短论文策略）\n\n4. WHEN 筛选完成时 THEN 系统SHALL记录选择的页面编号和分数，用于调试和验证\n\n5. IF 选出的页面总数超过配置的最大限制（例如10页）THEN 系统SHALL只处理得分最高的N页\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n- **模块化设计**：智能筛选功能应独立成函数，易于测试和维护\n- **向后兼容**：保持现有短论文全量扫描的逻辑不变\n- **配置驱动**：评分权重和阈值应可配置，便于调优\n- **错误隔离**：文本侦察阶段的错误不应影响视觉提取阶段\n\n### Performance\n- 文本侦察阶段应在100ms内完成典型PDF的处理\n- 阶段一处理不得对整体处理时间产生显著影响\n\n### Reliability\n- 即使pdfplumber失败，系统应回退到简单的截断策略\n- 保留现有错误处理和重试机制\n\n### Cost Efficiency\n- 长论文的API调用成本应降低30-50%\n- 数据提取成功率不应因页面筛选而下降\n",
  "fileStats": {
    "size": 3710,
    "lines": 82,
    "lastModified": "2026-01-06T15:13:16.041Z"
  },
  "comments": []
}